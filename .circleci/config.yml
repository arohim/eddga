version: 2
aliases:
  # Developer
  - &save-cache-gem
    save_cache:
      key: v1-gems-{{ checksum "Gemfile.lock" }}
      paths:
        - vendor/bundle
  - &restore-cache-gem
    restore_cache:
      keys:
        - v1-gems-{{ checksum "Gemfile.lock" }}
        - v1-gems-
  - &install-gem
    run: bundle check || bundle install --path=vendor/bundle --jobs 4 --retry 3
  - &save-cache-gradle
    save_cache:
      key: v1-eddga-{{ checksum "build.gradle" }}
      paths:
        - ~/.gradle
        - /home/circleci/project/.gradle
  - &restore-cache-gradle
    restore_cache:
      keys:
        - v1-eddga-{{ checksum "build.gradle" }}-
        - v1-eddga-
  - &install-gradle-dependencies
    run: ./gradlew dependencies -q
  - &dependencies
    - checkout
    - *restore-cache-gem
    - *install-gem
    - *save-cache-gem
    - *restore-cache-gradle
    - *install-gradle-dependencies
    - *save-cache-gradle

  # Requirement groups
  - &deps
    - "Install Dependencies"

## Declare jobs
base_job: &base-job
  machine: true
  no_output_timeout: 2h

jobs:
  "Install Dependencies":
    <<: *base-job
    steps: *dependencies

  "Lint":
    <<: *base-job
    steps:
      - checkout
      - *restore-cache-gem
      - *install-gem
      - *restore-cache-gradle
      - run:
          name: Run Lint
          command: echo "No Lint Yet!"

  "Unit Testing":
    <<: *base-job
    steps:
      - checkout
      - *restore-cache-gem
      - *install-gem
      - *restore-cache-gradle
      - run:
          name: Run Unit Tests
          command: bundle exec fastlane unit_test
      - store_artifacts:
          path: legacy/build/reports/
          destination: /reports/
      - store_test_results:
          path: legacy/build/test-results/
          destination: /test-results/

workflows:
  version: 2
  workflow:
    jobs:
      - "Install Dependencies":
          filters:
            branches:
              only:
                - /^feature\/.*/
                - /^release\/v.*/
                - /^hotfix\/v.*/
      - "Lint":
          requires: *deps
          filters:
            branches:
              only:
                - /^feature\/.*/
                - /^release\/v.*/
                - /^hotfix\/v.*/
      - "Unit Testing":
          requires: *deps
          filters:
            branches:
              only:
                - /^feature\/.*/
                - /^release\/v.*/
                - /^hotfix\/v.*/